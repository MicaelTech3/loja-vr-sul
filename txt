<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loja Virtual — Compre com PIX</title>
  <meta name="description" content="Loja Virtual: escolha produtos, adicione ao carrinho e pague via PIX com QR Code (simulado)."/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220; --muted:#0e172a; --card:#0f172a; --glass:rgba(255,255,255,.06);
      --txt:#e7ecf5; --txt-dim:#b9c4d9; --primary:#7c3aed; --primary-2:#3b82f6; --good:#10b981; --danger:#ef4444;
      --ring: 0 0 0 3px rgba(124,58,237,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(60% 60% at 10% 10%, rgba(124,58,237,.25), transparent 60%),
        radial-gradient(50% 50% at 90% 20%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(70% 70% at 40% 90%, rgba(16,185,129,.18), transparent 60%),
        var(--bg);
      color:var(--txt); font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; overflow-y:overlay;
    }
    a{color:inherit; text-decoration:none}
    button{font:inherit}
    .container{max-width:1200px; margin:0 auto; padding:0 16px}

    /* Topbar */
    .topbar{position:sticky; top:0; z-index:50; backdrop-filter: blur(10px); background:linear-gradient(180deg, rgba(11,18,32,.85), rgba(11,18,32,.55)); border-bottom:1px solid rgba(255,255,255,.08)}
    .topbar-wrap{display:flex; align-items:center; gap:16px; padding:14px 0}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .brand .logo{display:grid; place-items:center; width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,var(--primary),var(--primary-2)); box-shadow:0 8px 24px rgba(124,58,237,.35)}
    .brand span{font-size:20px}
    .search{flex:1; position:relative}
    .search input{width:100%; background:var(--glass); border:1px solid rgba(255,255,255,.1); color:var(--txt); padding:12px 44px 12px 14px; border-radius:12px; outline:none}
    .search input:focus{box-shadow:var(--ring); border-color:rgba(124,58,237,.45)}
    .search svg{position:absolute; right:12px; top:50%; transform:translateY(-50%); opacity:.7}
    .cart-btn{position:relative; padding:10px 14px; border-radius:12px; background:linear-gradient(135deg,var(--primary),var(--primary-2)); border:none; color:#fff; display:flex; align-items:center; gap:10px; cursor:pointer}
    .cart-btn .badge{position:absolute; top:-6px; right:-6px; background:#fff; color:#111827; border-radius:999px; min-width:22px; height:22px; padding:0 6px; display:grid; place-items:center; font-weight:700; font-size:12px}

    /* Categories */
    .cats{display:flex; gap:8px; overflow:auto; padding:10px 0 16px; scrollbar-width:none}
    .cats::-webkit-scrollbar{display:none}
    .cat{white-space:nowrap; padding:8px 12px; background:var(--glass); border:1px solid rgba(255,255,255,.1); border-radius:999px; color:var(--txt-dim); cursor:pointer}
    .cat.active{background:linear-gradient(135deg,rgba(124,58,237,.3),rgba(59,130,246,.25)); color:#fff; border-color:transparent}

    /* Hero */
    .hero{margin:16px 0 12px; background:linear-gradient(135deg, rgba(124,58,237,.5), rgba(59,130,246,.45)); padding:24px; border-radius:18px; border:1px solid rgba(255,255,255,.18)}
    .hero h2{margin:0 0 8px; font-size:28px}
    .hero p{margin:0; opacity:.9}

    /* Grid */
    .grid{display:grid; grid-template-columns:repeat(4,1fr); gap:16px}
    @media (max-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:480px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; transition:.2s ease; position:relative}
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .thumb{aspect-ratio: 16/11; background:linear-gradient(135deg, rgba(124,58,237,.45), rgba(59,130,246,.45)); display:grid; place-items:center}
    .thumb svg{opacity:.85}
    .card-body{padding:14px; display:flex; flex-direction:column; gap:8px}
    .title{font-weight:700}
    .price{display:flex; align-items:center; gap:8px}
    .price strong{font-size:18px}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{font-size:12px; color:#111827; background:#e5e7eb; border-radius:999px; padding:4px 8px}
    .chip.pix{background:#c7f9e9}
    .chip.boleto{background:#f3e8ff}
    .actions{display:flex; gap:8px; margin-top:8px}
    .btn{flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:var(--glass); color:#fff; cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-2)); border:none}

    /* Drawer (cart) */
    .drawer{position:fixed; top:0; right:-420px; width:400px; max-width:95vw; height:100%; background:rgba(10,14,24,.9); backdrop-filter: blur(12px); border-left:1px solid rgba(255,255,255,.12); transition:right .3s ease; z-index:100}
    .drawer.open{right:0}
    .drawer header{display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .drawer main{padding:12px 16px; height:calc(100% - 170px); overflow:auto}
    .drawer footer{position:absolute; bottom:0; left:0; right:0; padding:14px 16px; border-top:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.25)}
    .line{display:flex; gap:10px; align-items:center; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.08)}
    .line .q{display:flex; align-items:center; gap:6px}
    .qty{display:inline-flex; align-items:center; gap:6px; background:var(--glass); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:6px}
    .icon{width:20px; height:20px; display:grid; place-items:center; cursor:pointer; background:rgba(255,255,255,.08); border-radius:8px}
    .remove{margin-left:auto; color:#ffb4b4; background:rgba(239,68,68,.12)}
    .coupon{display:flex; gap:8px; margin:10px 0}
    .coupon input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:var(--glass); color:var(--txt)}
    .summary{display:grid; gap:6px; margin:10px 0; color:var(--txt-dim)}
    .summary strong{color:#fff}

    /* Modal */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:120}
    .modal.open{display:flex}
    .sheet{width:min(900px,95vw); background:var(--card); border:1px solid rgba(255,255,255,.12); border-radius:16px; overflow:hidden}
    .sheet header{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .sheet main{padding:16px}
    .close-x{background:rgba(255,255,255,.08); border:none; color:#fff; border-radius:10px; padding:6px 10px}

    .checkout-grid{display:grid; grid-template-columns: 1.3fr .7fr; gap:16px}
    @media (max-width:900px){.checkout-grid{grid-template-columns:1fr}}

    .field{display:grid; gap:6px}
    .field input,.field select{padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:var(--glass); color:#fff; outline:none}
    .pay-opt{display:flex; gap:8px; flex-wrap:wrap}
    .radio{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; background:var(--glass); border:1px solid rgba(255,255,255,.12); cursor:pointer}
    .radio.active{outline: var(--ring)}

    .pix-box{border:1px dashed rgba(255,255,255,.2); padding:12px; border-radius:12px; display:grid; gap:10px}
    .qrcode{width:220px; height:220px; background:#fff; display:grid; place-items:center; border-radius:12px}
    .copy{display:flex; gap:8px}
    .copy input{flex:1; background:var(--glass); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; color:#fff}

    .toast{position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(23,33,53,.95); border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:12px; display:none; z-index:200}
    .toast.show{display:block}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container topbar-wrap" role="navigation" aria-label="Topo">
      <a class="brand" href="#" aria-label="Página inicial Loja Virtual">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff"><path d="M7 21h10a2 2 0 0 0 2-2V8H5v11a2 2 0 0 0 2 2zm10-13 1-3H6l1 3h10z"/></svg>
        </div>
        <span>Loja Virtual</span>
      </a>
      <div class="search" role="search">
        <input id="searchInput" placeholder="Buscar produtos" aria-label="Buscar produtos" />
        <svg width="22" height="22" viewBox="0 0 24 24" fill="#fff" aria-hidden="true"><path d="M10 18a8 8 0 1 1 6.32-3.1l4.39 4.39-1.41 1.41-4.39-4.39A7.96 7.96 0 0 1 10 18z"/></svg>
      </div>
      <button id="cartOpenBtn" class="cart-btn" aria-haspopup="dialog" aria-controls="cartDrawer">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#fff" aria-hidden="true"><path d="M7 4h-2l-1 2h2l3.6 7.59-1.35 2.44a1.99 1.99 0 0 0 .25 2.18c.37.46.92.74 1.5.79H19v-2h-8.42c-.14 0-.25-.11-.26-.25l.03-.12.9-1.63H17a2 2 0 0 0 1.8-1.1l3.58-7.16L20.42 4H7zm-1 16a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
        <span>Carrinho</span>
        <span id="cartBadge" class="badge">0</span>
      </button>
    </div>
  </header>

  <div class="container">
    <div class="cats" id="cats"></div>

    <section class="hero" aria-labelledby="hero-title">
      <h2 id="hero-title">Mega Ofertas de Hoje</h2>
      <p>Frete grátis acima de R$ 199 • Pague no PIX com 10% OFF usando o cupom <strong>BEMVINDO</strong></p>
    </section>

    <section aria-label="Lista de produtos">
      <div id="grid" class="grid"></div>
    </section>
  </div>

  <!-- Drawer: Carrinho -->
  <aside id="cartDrawer" class="drawer" role="dialog" aria-labelledby="cartTitle" aria-modal="true">
    <header>
      <strong id="cartTitle">Seu carrinho</strong>
      <button id="cartCloseBtn" class="close-x" aria-label="Fechar carrinho">Fechar</button>
    </header>
    <main id="cartLines"></main>
    <footer>
      <div class="coupon">
        <input id="couponInput" placeholder="Cupom (ex: BEMVINDO)" />
        <button id="applyCouponBtn" class="btn">Aplicar</button>
      </div>
      <div class="summary">
        <div>Itens: <strong id="sumItems">0</strong></div>
        <div>Subtotal: <strong id="sumSubtotal">R$ 0,00</strong></div>
        <div>Descontos: <strong id="sumDiscounts">-</strong></div>
        <div>Total: <strong id="sumTotal">R$ 0,00</strong></div>
      </div>
      <button id="checkoutBtn" class="btn primary" style="width:100%">Finalizar compra</button>
    </footer>
  </aside>

  <!-- Modal: Checkout -->
  <div id="checkoutModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="checkoutTitle">
    <div class="sheet">
      <header>
        <strong id="checkoutTitle">Checkout</strong>
        <button class="close-x" id="closeCheckout">Fechar</button>
      </header>
      <main>
        <div class="checkout-grid">
          <div class="left">
            <div class="field"><label>CEP</label><input id="cep" placeholder="00000-000" inputmode="numeric"></div>
            <div class="field" style="margin-top:10px"><label>Endereço</label><input id="address" placeholder="Rua, número, complemento"></div>
            <div class="field" style="margin-top:10px"><label>Cidade / UF</label><div style="display:flex; gap:8px"><input id="city" placeholder="Cidade" style="flex:1"><input id="uf" placeholder="UF" maxlength="2" style="width:80px;text-transform:uppercase"></div></div>
            <div class="field" style="margin-top:12px"><label>Forma de Pagamento</label>
              <div class="pay-opt">
                <div class="radio active" data-method="pix"><input type="radio" name="pay" checked> PIX <small style="opacity:.75">(simulação)</small></div>
                <div class="radio" data-method="card"><input type="radio" name="pay"> Cartão</div>
                <div class="radio" data-method="boleto"><input type="radio" name="pay"> Boleto</div>
              </div>
            </div>

            <div id="pixSection" class="pix-box" style="margin-top:12px">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
                <div>
                  <strong>Pague com PIX</strong>
                  <div style="opacity:.75">Escaneie o QR Code ou use copia e cola. Expira em <span id="pixTimer">15:00</span>.</div>
                </div>
                <div style="text-align:right">
                  <div style="opacity:.75;font-size:12px">Total</div>
                  <div id="pixTotal" style="font-size:22px; font-weight:800">R$ 0,00</div>
                </div>
              </div>
              <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap">
                <div class="qrcode" id="qrcode" aria-label="QR Code do PIX"></div>
                <div style="flex:1; min-width:240px">
                  <small style="opacity:.75">PIX copia e cola</small>
                  <div class="copy">
                    <input id="pixCopy" readonly>
                    <button id="copyBtn" class="btn">Copiar</button>
                  </div>
                  <div style="display:flex; gap:8px; margin-top:8px">
                    <button id="paidBtn" class="btn primary">Já paguei</button>
                    <button id="cancelPix" class="btn">Cancelar</button>
                  </div>
                </div>
              </div>
            </div>

            <div id="otherMethod" class="pix-box" style="display:none; margin-top:12px">
              <small>Este checkout de exemplo só confirma o pagamento via PIX (simulado). Outras formas estão como placeholder.</small>
            </div>
          </div>
          <div class="right">
            <div class="pix-box">
              <strong>Resumo do Pedido</strong>
              <div id="resumeList" style="margin-top:8px; display:grid; gap:8px"></div>
              <div class="summary" style="margin-top:10px">
                <div>Subtotal: <strong id="resumeSubtotal">R$ 0,00</strong></div>
                <div>Descontos: <strong id="resumeDiscounts">-</strong></div>
                <div>Total: <strong id="resumeTotal">R$ 0,00</strong></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ======== Utils ========
    const BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const el = sel => document.querySelector(sel);
    const els = sel => [...document.querySelectorAll(sel)];
    const setText = (sel, v) => (el(sel).textContent = v);
    function toast(msg){ const t = el('#toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); }

    // ======== Data ========
    const CATEGORIES = ['Tudo','Moda','Eletrônicos','Casa','Beleza','Esporte'];
    const PRODUCTS = [
      {id:'p1', title:'Fone Bluetooth Pro', price:199.90, cat:'Eletrônicos'},
      {id:'p2', title:'Tênis Runner X', price:259.90, cat:'Esporte'},
      {id:'p3', title:'Cafeteira Smart 110v', price:329.00, cat:'Casa'},
      {id:'p4', title:'Creme Facial 50ml', price:89.90, cat:'Beleza'},
      {id:'p5', title:'Camisa Oversize', price:79.90, cat:'Moda'},
      {id:'p6', title:'Soundbar 120W', price:599.00, cat:'Eletrônicos'},
      {id:'p7', title:'Luminária RGB', price:149.90, cat:'Casa'},
      {id:'p8', title:'Relógio Fit', price:299.00, cat:'Esporte'},
    ];

    // ======== Render Categories ========
    const catsWrap = el('#cats');
    let activeCat = 'Tudo';
    function renderCats(){
      catsWrap.innerHTML = CATEGORIES.map(c=>`<button class="cat ${c===activeCat?'active':''}" data-cat="${c}">${c}</button>`).join('');
    }

    // ======== Render Products ========
    const grid = el('#grid');
    function productCard(p){
      return `<article class="card" data-id="${p.id}">
        <div class="thumb" aria-hidden="true">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="#fff"><path d="M21 19V7l-9-4-9 4v12l9 4 9-4zM6.74 8.92 12 6.5l5.26 2.42L12 11.34 6.74 8.92z"/></svg>
        </div>
        <div class="card-body">
          <div class="title">${p.title}</div>
          <div class="price"><strong>${BRL.format(p.price)}</strong><small class="chip pix">PIX</small><small class="chip boleto">Boleto</small></div>
          <div class="actions">
            <button class="btn" data-act="fav" aria-label="Favoritar">❤</button>
            <button class="btn primary" data-act="add">Adicionar</button>
          </div>
        </div>
      </article>`
    }

    function renderProducts(){
      const term = el('#searchInput').value.trim().toLowerCase();
      const list = PRODUCTS.filter(p => (activeCat==='Tudo' || p.cat===activeCat) && p.title.toLowerCase().includes(term));
      grid.innerHTML = list.map(productCard).join('');
    }

    // ======== Cart ========
    const CART_KEY = 'loja_virtual_cart_v1';
    const COUPON_KEY = 'loja_virtual_coupon_v1';
    let cart = JSON.parse(localStorage.getItem(CART_KEY) || '{}'); // {id: qty}
    let coupon = localStorage.getItem(COUPON_KEY) || '';

    function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateBadge(); }
    function setCoupon(v){ coupon = v?.toUpperCase() || ''; localStorage.setItem(COUPON_KEY, coupon); }

    function cartItems(){ return Object.entries(cart).map(([id,qty]) => ({...PRODUCTS.find(p=>p.id===id), qty})); }
    function subtotal(){ return cartItems().reduce((s,it)=> s + it.price*it.qty, 0); }
    function discounts(){
      // Cupom "BEMVINDO" dá 10% no subtotal
      if(coupon === 'BEMVINDO') return subtotal()*0.10; return 0;
    }
    function total(){ return Math.max(subtotal() - discounts(), 0); }

    function updateBadge(){ el('#cartBadge').textContent = cartItems().reduce((s,i)=>s+i.qty,0); }

    function addToCart(id){ cart[id] = (cart[id]||0) + 1; saveCart(); renderCart(); toast('Adicionado ao carrinho'); }
    function removeFromCart(id){ delete cart[id]; saveCart(); renderCart(); }
    function setQty(id, qty){ cart[id] = Math.max(1, Math.min(99, qty|0)); saveCart(); renderCart(); }

    const drawer = el('#cartDrawer');
    const lines = el('#cartLines');

    function renderCart(){
      const items = cartItems();
      lines.innerHTML = items.length ? items.map(it => `
        <div class="line">
          <div style="width:52px; height:52px; border-radius:10px; background:linear-gradient(135deg, rgba(124,58,237,.4), rgba(59,130,246,.4));"></div>
          <div style="flex:1">
            <div style="font-weight:600">${it.title}</div>
            <div style="opacity:.75">${BRL.format(it.price)}</div>
          </div>
          <div class="q">
            <div class="qty">
              <span class="icon" data-minus="${it.id}" aria-label="Diminuir">−</span>
              <span style="min-width:20px; text-align:center">${it.qty}</span>
              <span class="icon" data-plus="${it.id}" aria-label="Aumentar">＋</span>
            </div>
            <button class="icon remove" data-rm="${it.id}" aria-label="Remover">✕</button>
          </div>
        </div>`).join('') : '<div style="opacity:.7; padding:12px">Seu carrinho está vazio.</div>';

      setText('#sumItems', items.reduce((s,i)=>s+i.qty,0));
      setText('#sumSubtotal', BRL.format(subtotal()));
      setText('#sumDiscounts', discounts()? ('- ' + BRL.format(discounts())) : '-');
      setText('#sumTotal', BRL.format(total()));
      el('#couponInput').value = coupon;
      // resume on checkout
      renderResume();
    }

    function openDrawer(){ drawer.classList.add('open'); drawer.focus(); }
    function closeDrawer(){ drawer.classList.remove('open'); }

    // ======== Checkout & PIX ========
    const checkout = el('#checkoutModal');

    function openCheckout(){
      if(!Object.keys(cart).length){ toast('Adicione produtos antes de finalizar.'); return; }
      checkout.classList.add('open');
      // default: PIX
      selectMethod('pix');
      // Generate PIX payload + QR
      generatePix();
    }
    function closeCheckout(){ checkout.classList.remove('open'); }

    function selectMethod(m){
      els('.radio').forEach(r=>{ r.classList.toggle('active', r.dataset.method===m); });
      el('#pixSection').style.display = m==='pix' ? 'grid' : 'none';
      el('#otherMethod').style.display = m==='pix' ? 'none' : 'grid';
    }

    function renderResume(){
      const items = cartItems();
      el('#resumeList').innerHTML = items.map(i=>`<div style="display:flex; justify-content:space-between; gap:8px"><span>${i.qty}× ${i.title}</span><strong>${BRL.format(i.price*i.qty)}</strong></span>`).join('');
      setText('#resumeSubtotal', BRL.format(subtotal()));
      setText('#resumeDiscounts', discounts()? ('- ' + BRL.format(discounts())) : '-');
      setText('#resumeTotal', BRL.format(total()));
      setText('#pixTotal', BRL.format(total()));
    }

    // Very small QR generator (qrcodejs, minified) embedded
  </script>
  <script>
    /* qrcode.js (minified, excerpt) — https://github.com/davidshimjs/qrcodejs */
    // License: MIT. Reduced build containing QRCode and QRCode.CorrectLevel only.
    (function(o){function p(a){this.mode=c.MODE_8BIT_BYTE;this.data=a}function q(a,b){this.typeNumber=a;this.errorCorrectLevel=b;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[]}var c={PAD0:236,PAD1:17,MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8,ErrorCorrectLevel:{L:1,M:0,Q:3,H:2}},r=function(){var a=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];return function(b){return 48<=b&&57>=b?b-48:65<=b&&90>=b?b-55:97<=b&&122>=b?b-61:-1}}();q.prototype={addData:function(a){a=new p(a);this.dataList.push(a);this.dataCache=null},isDark:function(a,b){if(0>b||this.moduleCount<=b||0>a||this.moduleCount<=a)throw Error(a+","+b);return this.modules[b][a]},getModuleCount:function(){return this.moduleCount},make:function(){if(1>this.typeNumber){for(var a=1;40>a;a++){for(var b=d.getRSBlocks(a,this.errorCorrectLevel),e=new t,c=0;c<b.length;c++)e.totalDataCount+=b[c].dataCount;e.totalDataCount>=this.getDataCount()&&(this.typeNumber=a);if(this.typeNumber)break}}this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(a,b){this.moduleCount=4*this.typeNumber+17;this.modules=Array(this.moduleCount);for(var e=0;e<this.moduleCount;e++){this.modules[e]=Array(this.moduleCount);for(var k=0;k<this.moduleCount;k++)this.modules[e][k]=null}this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();this.setupTimingPattern();this.setupTypeInfo(a,b);7<=this.typeNumber&&this.setupTypeNumber(a);null==this.dataCache&&(this.dataCache=d.createData(this.typeNumber,this.errorCorrectLevel,this.dataList));this.mapData(this.dataCache,b)},setupPositionProbePattern:function(a,b){for(var e=-1;7>=e;e++)if(!(0>a+e||this.moduleCount<=a+e))for(var k=-1;7>=k;k++)0>b+k||this.moduleCount<=b+k||(this.modules[b+k][a+e]=0<=e&&6>=e&&(0==k||6==k)||0<=k&&6>=k&&(0==e||6==e)||2<=e&&4>=e&&2<=k&&4>=k)},getBestMaskPattern:function(){for(var a=0,b=0,e=0;8>e;e++){this.makeImpl(!0,e);var k=u.getLostPoint(this);if(0==e||a>k)a=k,b=e}return b},setupTimingPattern:function(){for(var a=8;a<this.moduleCount-8;a++)null==this.modules[6][a]&&(this.modules[6][a]=0==a%2),null==this.modules[a][6]&&(this.modules[a][6]=0==a%2)},setupPositionAdjustPattern:function(){for(var a=u.getPatternPosition(this.typeNumber),b=0;b<a.length;b++)for(var e=0;e<a.length;e++){var k=a[b],f=a[e];if(null==this.modules[f][k])for(var g=-2;2>=g;g++)for(var h=-2;2>=h;h++)this.modules[f+h][k+g]=-2==g||2==g||-2==h||2==h||0==g&&0==h}},setupTypeNumber:function(a){for(var b=u.getBCHTypeNumber(this.typeNumber),e=0;18>e;e++){var k=!a&&1==(b>>e&1);this.modules[Math.floor(e/3)][e%3+this.moduleCount-8-3]=k;this.modules[e%3+this.moduleCount-8-3][Math.floor(e/3)]=k}},setupTypeInfo:function(a,b){for(var e=c.ErrorCorrectLevel[this.errorCorrectLevel],k=u.getBCHTypeInfo(e<<3|b),f=0;15>f;f++){var g=!a&&1==(k>>f&1);6>f?this.modules[f][8]=g:8>f?this.modules[f+1][8]=g:this.modules[this.moduleCount-15+f][8]=g}for(f=0;15>f;f++){g=!a&&1==(k>>f&1);8>f?this.modules[8][this.moduleCount-1-f]=g:9>f?this.modules[8][15-f-1+1]=g:this.modules[8][15-f-1]=g}this.modules[this.moduleCount-8][8]=!a},mapData:function(a,b){for(var e=-1,k=this.moduleCount-1,f=-1,g=this.moduleCount-1;0<g;g-=2){6==g&&g--;for(;;){for(var h=0;2>h;h++)null==this.modules[k][g-h]&&(e<0?this.modules[k][g-h]=0==(a[f>>>3]>>>7-(f&7)&1):this.modules[k][g-h]=e,!0==e&&(e=!1),f++);if((k+=e?-1:1)<0||this.moduleCount<=k){k-=e?-1:1;e*=-1;break}}}},getDataCount:function(){var a=0;for(let b=0;b<this.dataList.length;b++){var e=this.dataList[b];a+=e.data.length}return a}};var u={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(a){for(var b=a<<10;this.getBCHDigit(b)-this.getBCHDigit(this.G15)>=0;)b^=this.G15<<this.getBCHDigit(b)-this.getBCHDigit(this.G15);return a<<10|b},getBCHTypeNumber:function(a){for(var b=a<<12;this.getBCHDigit(b)-this.getBCHDigit(this.G18)>=0;)b^=this.G18<<this.getBCHDigit(b)-this.getBCHDigit(this.G18);return a<<12|b},getBCHDigit:function(a){for(var b=0;0!=a;)b++,a>>>=1;return b},getPatternPosition:function(a){return this.PATTERN_POSITION_TABLE[a-1]},getMask:function(a,b,e){switch(e){case 0:return 0==(a+b)%2;case 1:return 0==a%2;case 2:return 0==b%3;case 3:return 0==(a+b)%3;case 4:return 0==(Math.floor(a/2)+Math.floor(b/3))%2;case 5:return 0==a*b%2+ a*b%3;case 6:return 0==(a*b%2+a*b%3)%2;case 7:return 0==(a*b%3+(a+b)%2)%2;default:throw new Error("bad maskPattern:"+e)}},getLostPoint:function(a){for(var b=a.getModuleCount(),e=0,k=0;k<b;k++)for(var f=0;f<b;f++){for(var g=0,h=a.isDark(f,k),l=-1;1>=l;l++)if(!(0>k+l||b<=k+l))for(var m=-1;1>=m;m++)0>f+m||b<=f+m||0==l&&0==m||h==a.isDark(f+m,k+l)&&g++;5<g&&(e+=3+g-5);if(0<=f&&f<b-1&&0<=k&&k<b-1&&(h=a.isDark(f,k)))a.isDark(f+1,k)&&a.isDark(f,k+1)&&a.isDark(f+1,k+1)&&(e+=3)}for(k=0;k<b;k++)for(f=0;f<b;f++)if(a.isDark(f,k))for(g=0;g<5&&f+g<b&&a.isDark(f+g,k);g++);for(k=0;k<b;k++)for(f=0;f<b;f++)if(a.isDark(f,k))for(g=0;g<5&&k+g<b&&a.isDark(f,k+g);g++);return e}};var d=function(){function a(b,e){this.buffer=[];this.length=0;null!=b&&("number"==typeof b?this.put(b,e):this.putString(b))}a.prototype={get:function(a){return 1==(this.buffer[a>>>3]>>>7-(a&7)&1)},put:function(b,e){for(let k=0;k<e;k++)this.putBit(1==(b>>>e-k-1&1))},putBit:function(b){let e=this.length>>>3;this.buffer.length<=e&&this.buffer.push(0);b&&(this.buffer[e]|=128>>>this.length%8);this.length++},putString:function(b){for(let e=0;e<b.length;e++){let k=b.charCodeAt(e);this.put(k,8)}},getLengthInBits:function(){return this.length}};return {createData:function(b,e,k){for(var f=d.getRSBlocks(b,e),g=new a,h=0;h<k.length;h++){var l=k[h];g.put(l.mode,4);g.put(l.data.length,8);for(let m=0;m<l.data.length;m++)g.put(l.data.charCodeAt(m),8)}for(h=0;h<f.length;h++);for(;g.getLengthInBits()%8!=0;)g.put(0,1);return g.buffer},getRSBlocks:function(){return[{dataCount:10}]}}}();
    window.QRCode=q; window.QRErrorCorrectLevel=c.ErrorCorrectLevel;
  })();
  </script>

  <script>
    // Generate a simple PIX payload (SIMULATION — not compliant for real payments)
    function makePixPayload(total){
      const chave = 'pagamentos@lojavirtual.com.br';
      const txid = 'LV' + Date.now().toString(36).toUpperCase();
      return `PIX|LojaVirtual|chave:${chave}|txid:${txid}|valor:${total.toFixed(2)}|info:Pedido Loja Virtual (SIMULACAO)`;
    }

    let timerId; let remaining = 15*60; // 15 minutes
    function startTimer(){ clearInterval(timerId); remaining = 15*60; updateTimer(); timerId=setInterval(()=>{remaining--; updateTimer(); if(remaining<=0){clearInterval(timerId); toast('PIX expirado. Gere novamente.');}},1000); }
    function updateTimer(){ const m = String(Math.floor(remaining/60)).padStart(2,'0'); const s=String(remaining%60).padStart(2,'0'); setText('#pixTimer', `${m}:${s}`); }

    function generatePix(){
      renderResume();
      const payload = makePixPayload(total());
      el('#pixCopy').value = payload;
      // Render QR
      el('#qrcode').innerHTML='';
      try{
        const q = new QRCode(4, 'M');
        q.addData(payload); q.make();
        // draw to canvas
        const size=220; const c=document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d');
        const count=q.getModuleCount(); const tile=size/count; ctx.fillStyle='#fff'; ctx.fillRect(0,0,size,size); ctx.fillStyle='#000';
        for(let r=0;r<count;r++){ for(let col=0;col<count;col++){ if(q.isDark(r,col)){ ctx.fillRect(Math.round(col*tile), Math.round(r*tile), Math.ceil(tile), Math.ceil(tile)); } } }
        el('#qrcode').appendChild(c);
      }catch(e){ el('#qrcode').textContent = 'QR indisponível'; }
      startTimer();
    }

    // ======== Events ========
    document.addEventListener('click', (ev)=>{
      const a = ev.target;
      if(a.matches('[data-act="add"]')){ const id = a.closest('.card').dataset.id; addToCart(id); }
      if(a.matches('#cartOpenBtn')) openDrawer();
      if(a.matches('#cartCloseBtn')) closeDrawer();
      if(a.matches('[data-plus]')) setQty(a.dataset.plus, (cart[a.dataset.plus]||1)+1);
      if(a.matches('[data-minus]')) setQty(a.dataset.minus, (cart[a.dataset.minus]||1)-1);
      if(a.matches('[data-rm]')) removeFromCart(a.dataset.rm);
      if(a.matches('#applyCouponBtn')){ setCoupon(el('#couponInput').value); renderCart(); toast(coupon?`Cupom ${coupon} aplicado!`:'Cupom removido'); }
      if(a.matches('#checkoutBtn')){ closeDrawer(); openCheckout(); }
      if(a.matches('#closeCheckout')) closeCheckout();
      if(a.closest('.radio')){ selectMethod(a.closest('.radio').dataset.method); }
      if(a.matches('#copyBtn')){ navigator.clipboard.writeText(el('#pixCopy').value); toast('Chave PIX copiada!'); }
      if(a.matches('#paidBtn')){ toast('Pagamento confirmado (simulação)'); cart={}; saveCart(); renderCart(); closeCheckout(); }
      if(a.matches('#cancelPix')){ closeCheckout(); }
    });

    el('#searchInput').addEventListener('input', renderProducts);
    catsWrap.addEventListener('click', (e)=>{ const b=e.target.closest('.cat'); if(!b)return; activeCat=b.dataset.cat; renderCats(); renderProducts(); });

    // ======== Init ========
    renderCats(); renderProducts(); renderCart(); updateBadge();
  </script>
</body>
</html>
